<!DOCTYPE html><html>
<head>
  <title>Hand Arrange - Centered & Pointer Drag</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas, video { position: absolute; top: 0; left: 0; }
    #upload { position: fixed; top: 10px; left: 10px; z-index: 10; }
  </style>
</head>
<body>
  <input type="file" id="upload" accept="image/*">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');let images = JSON.parse(localStorage.getItem('images') || '[]');
let selectedImageIndex = null;

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Load saved images
const imgObjects = [];
images.forEach(imgData => {
  const img = new Image();
  img.src = imgData.src;
  img.onload = () => imgObjects.push({ img, ...imgData });
});

// Upload handler
document.getElementById('upload').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const img = new Image();
    img.src = reader.result;
    img.onload = () => {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const imageData = { src: reader.result, x: centerX, y: centerY, scale: 1, rotation: 0 };
      imgObjects.push({ img, ...imageData });
      images.push(imageData);
      localStorage.setItem('images', JSON.stringify(images));
    };
  };
  reader.readAsDataURL(file);
});

function distance(x1, y1, x2, y2) {
  return Math.sqrt((x1 - x2) ** 2 + (y1 - y2) ** 2);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  imgObjects.forEach(obj => {
    ctx.save();
    ctx.translate(obj.x, obj.y);
    ctx.rotate(obj.rotation);
    ctx.scale(obj.scale, obj.scale);
    ctx.drawImage(obj.img, -obj.img.width / 2, -obj.img.height / 2);
    ctx.restore();
  });
}

function updateImagePositions(pointerX, pointerY) {
  if (selectedImageIndex !== null) {
    imgObjects[selectedImageIndex].x = pointerX;
    imgObjects[selectedImageIndex].y = pointerY;
    images[selectedImageIndex].x = pointerX;
    images[selectedImageIndex].y = pointerY;
    localStorage.setItem('images', JSON.stringify(images));
  }
}

function onResults(results) {
  draw();
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    const landmarks = results.multiHandLandmarks[0];
    const indexTip = landmarks[8]; // ko'rsatkich barmoq uchi
    const pointerX = indexTip.x * canvas.width;
    const pointerY = indexTip.y * canvas.height;

    if (selectedImageIndex === null) {
      // Find closest image to pointer
      let minDist = Infinity;
      let closestIndex = null;
      imgObjects.forEach((obj, i) => {
        const d = distance(pointerX, pointerY, obj.x, obj.y);
        if (d < minDist) {
          minDist = d;
          closestIndex = i;
        }
      });
      if (minDist < 80) {
        selectedImageIndex = closestIndex;
      }
    } else {
      updateImagePositions(pointerX, pointerY);
    }
  } else {
    selectedImageIndex = null; // release when hand not visible
  }
}

const hands = new Hands({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.5
});
hands.onResults(onResults);

const camera = new Camera(video, {
  onFrame: async () => {
    await hands.send({image: video});
  },
  width: 640,
  height: 480
});
camera.start();

draw();

  </script>
</body>
</html>
